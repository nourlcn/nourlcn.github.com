--- 
title: Linux LVM 改变分区大小
type: post
layout: post
tags: 
- Linux
- LVM
---
需求：<br />服务器上挂载了一块2T的硬盘，但/home只有100G左右，Hadoop DataNode节点安装在/home内，需要存储处理大量数据。<br /><br />学习:<br /><a href="http://www.ibm.com/developerworks/cn/linux/filesystem/lvm/lvm-1/index.html">什么是LVM？</a><br /><br />主要步骤：<br />1）通过fdisk 工具将磁盘转换为linux分区<br />2）通过pvcreate命令将linux分区转换成物理卷（PV)；<br />3）通过vgcreate命令将创建好的物理卷处理成卷组（VG)；<br />4）通过lvcreate命令将卷组分成若干个逻辑卷（LV)；<br />5）对逻辑卷进行格式化，挂载，动态调整逻辑卷的大小，并且该操作不会影响逻辑卷（Lv)上的数据。<br /><br />以下详细列出可能用到的命令：<br />1. 使用fdisk -l 命令查看磁盘分区<br /><br /><span style="color: magenta;">sudo fdisk -l</span><br /><br />Disk /dev/sda: 1999.3 GB, 1999307276288 bytes<br />255 heads, 63 sectors/track, 243068 cylinders<br />Units = cylinders of 16065 * 512 = 8225280 bytes<br />Sector size (logical/physical): 512 bytes / 512 bytes<br />I/O size (minimum/optimal): 512 bytes / 512 bytes<br />Disk identifier: 0x0002e54e<br /><br />   Device Boot      Start         End      Blocks   Id  System<br />/dev/sda1               1           1        1024   83  Linux<br />Partition 1 does not end on cylinder boundary.<br />/dev/sda2               1      243069  1952445440   8e  Linux LVM<br /><br />可以看到分区sda共有近2个T的容量，sda1的type为Linux；sda2为Linux LVM类型。<br /><br />如果是新挂载的空白磁盘，可以使用fdisk命令将磁盘转换为Linux LVM类型。然后执行2，3步骤。<br /><br />2. 将linux物理分区转变为物理卷 （针对新的LVM类型分区）<br /><span style="color: magenta;">$pvcreate /dev/sdb{1,2}</span> <span style="color: blue;"> #将物理分区/dev/sdb{1,2}转变为物理卷</span>执行此命令成功后，会提示success！<br /><br />执行pvdisplay可以查看物理卷的详细信息:<br /><span style="color: magenta;">$ sudo pvdisplay </span><br />  --- Physical volume ---<br />  PV Name               /dev/sda2<br />  VG Name               vg00<br />  PV Size               1.82 TiB / not usable 1.00 MiB<br />  Allocatable           yes <br />  PE Size               4.00 MiB<br />  Total PE              476671<br />  Free PE               185166<br />  Allocated PE          291505<br />  PV UUID               JsAGuo-Fi0u-nHUc-WBuq-Tqg7-cseM-CcB2tl<br /><br />通过执行pvscan，可以查看物理卷总容量、已用、剩余的情况：<br /><span style="color: magenta;">$ sudo pvscan </span><br />  PV /dev/sda2   VG vg00   lvm2 [1.82 TiB / 723.30 GiB free]<br />  Total: 1 [1.82 TiB] / in use: 1 [1.82 TiB] / in no VG: 0 [0   ]<br /><br />共有1个物理卷vg00，1.82TB，723.30GB空闲可用，其余已经分配<br /><br />删除物理卷使用pvremove命令，例如：<br /><span style="color: magenta;">$pvremove /dev/sdb2 </span><span style="color: blue;">  #删除物理卷，</span>Labels on physical volume "/dev/sdb2" successfully wiped<br /><br />3. 使用vgcreate命令将PV创建成卷组VG，VG创建后，可以方便的从VG中为逻辑卷LV分配/回收空间<br />创建VG：<br /><span style="color: magenta;">$vgcreate vg00 /dev/sda2</span> <span style="color: blue;"> #将已经是物理卷的/dev/sda2转化为卷组名为vg00的卷组</span>若有多个物理卷创建一个VG，可以使用<span style="color: magenta;">vgcreate vg00 /dev/sda{1,2}形式</span><br />执行vgscan可以查看当前存在的卷组：<br /><span style="color: magenta;">$ sudo vgscan </span><br />  Reading all physical volumes.  This may take a while...<br />  Found volume group "vg00" using metadata type lvm2<br /><br />使用vgdisplay可以查看当前卷组的详细情况;<br />mk@log1:~$ sudo vgdisplay <br />  --- Volume group ---<br />  VG Name               vg00<br />  System ID             <br />  Format                lvm2<br />  Metadata Areas        1<br />  Metadata Sequence No  21<br />  VG Access             read/write<br />  VG Status             resizable<br />  MAX LV                0<br />  Cur LV                4<br />  Open LV               4<br />  Max PV                0<br />  Cur PV                1<br />  Act PV                1<br />  VG Size               1.82 TiB<br />  PE Size               4.00 MiB<br />  Total PE              476671<br />  Alloc PE / Size       291505 / 1.11 TiB<br />  Free  PE / Size       185166 / 723.30 GiB<br />  VG UUID               eOAdfu-WrNY-znxa-U0Zv-NdmY-ANW8-utbvCH<br /><br />若为卷组增加一个物理卷，可以使用vgextend：<br /><span style="color: magenta;">$pvcreate /dev/sda3 </span> <span style="color: blue;"> #先创建一个新的物理卷<br /></span>  Physical volume "/dev/sda3" successfully created<br /><span style="color: magenta;">$vgextend vg00 /dev/sda3</span><span style="color: blue;"> #再将新增的物理卷添加到vg00卷组中<br /></span>  Volume group "vg01" successfully extended<br /><br />删除卷组使用vgremove命令:<br /><span style="color: magenta;">$vgremove /dev/vg00</span><br /><br /><span style="color: blue;">****对于前面提到的需求，如果2，3两步已经完成，可直接执行第四步。<br />****注意：</span><span style="color: blue;">先将/下的/home备份为/home_old，然后在/下创建/home路径，再执行下面的挂载！！</span><br /><br />4. 创建逻辑卷lvcreate<br />创建逻辑卷共分为两个部分，lvcreate一个逻辑卷，并且格式化逻辑卷为制定的文件系统<br />1）创建逻辑卷大小为1000G卷名为home，从vg00生成<br /><span style="color: magenta;">$lvcreate -L 1000G -n home vg00</span> <span style="color: blue;"> #从卷组vg00上划分1000G的空间为逻辑卷home</span><br />2）对划分的逻辑卷进行格式化<br /><span style="color: magenta;">$mkfs -t ext3 /dev/vg00/home</span>  <span style="color: blue;">#以ext3的文件格式化逻辑卷<br /></span>执行lvscan可以查看当前vg中的逻辑卷:<br /><span style="color: magenta;">$ sudo lvscan</span><br />  ACTIVE            '/dev/vg00/boot' [92.00 MiB] inherit<br />  ACTIVE            '/dev/vg00/swap' [3.72 GiB] inherit<br />  ACTIVE            '/dev/vg00/root' [110.88 GiB] inherit<br />  ACTIVE            '/dev/vg00/home' [1.00 TiB] inherit<br />同理，lvdisplay可以查看具体信息。<br /><br />使用lvextend/lvreduce可以增加或者减小逻辑卷的大小：<br />使用lvextend增大逻辑卷大小：<br /><span style="color: magenta;">$lvextend -L +1G /dev/vg00/home  </span><span style="color: blue;"> #从卷组vg00上对逻辑卷/dev/vg00/homne进行扩容1G</span>使用lvreduce减小逻辑卷大小，必须是离线方式(即先umount文件系统)<br /><span style="color: magenta;">$lvreduce -L -1G /dev/vg00/home </span> <span style="color: blue;"> #将逻辑卷/dev/vg00/home容量减小1GB</span><br /><br />使用resize2fs命令更新系统识别的文件系统大小，立即生效<span style="color: magenta;"><br />$resize2fs /dev/vg00/home </span>  #使增加的逻辑卷大小立即生效<br />如果提示busy，可以先umount文件系统，resize之后再mount<br /><br />删除逻辑卷使用lvremove /dev/vg00/home<br /><br />5. 挂载逻辑卷<br />步骤4之后，使用<span style="color: magenta;">$mount /dev/vg00/home /home 即可将逻辑卷挂在之前创建的/home下</span><span style="color: magenta;"></span><span style="color: blue;"></span><span style="color: magenta;"></span><br />使用df命令，可以查看当前系统空间分配，/home有1T的大小，已用11G，可用947G<br />mk@log1:~$ sudo df -lh<br />/dev/mapper/vg00-home<br />                     1008G   11G  947G   2% /home<br />......<br /><br />Done！
