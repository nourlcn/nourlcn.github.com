---
title:  linux kenerl tcp ip source code
type: post
layout: post
tags: 
- Code
---
<br/>调用系统提供的API（应用编程接口），程序员可以使用系统提供的网络功能。<br/>Unix/Linux领域，常用的套接字为BSD套接字（Berkeley Socket）：<br/><br/>一.套接字的地址：包括三个属性，协议，IP地址，端口号，具体实现为一个结构体<br/><div style="font-size: 12px; line-height: 12px; font-family: courier new;"><br/><table style="width: 100%; border: 0px; padding: 0px;" cellspacing="0"><br/><tbody><br/><tr><br/><td style="color: teal;" valign="top">1</td><br/><td><strong><span style="color: #0000ff;">typedef</span></strong><span style="color: #000000;"> </span><strong><span style="color: #0000ff;">unsigned</span></strong><span style="color: #000000;"> </span><strong><span style="color: #0000ff;">short</span></strong><span style="color: #000000;"> </span><span style="color: #000000;">sa_family_t;</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">2</td><br/><td><strong><span style="color: #0000ff;">struct</span></strong><span style="color: #000000;"> </span><span style="color: #000000;">sockaddr</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">3</td><br/><td><span style="color: #000000;">{</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">4</td><br/><td><span style="color: #000000;">sa_family_t</span><span style="color: #000000;"> </span><span style="color: #000000;">sa_family;</span><span style="color: #000000;"> </span><span style="color: #008000;">//</span><span style="color: #008000;">注册套接字的地址族，AF_INET代表IP地址族</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">5</td><br/><td><strong><span style="color: #0000ff;">char</span></strong><span style="color: #000000;"> </span><span style="color: #000000;">sa_data[</span><strong><span style="color: #008080;">14</span></strong><span style="color: #000000;">];</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">6</td><br/><td><span style="color: #000000;">}</span><span style="color: #000000;">;</span></td><br/></tr><br/></tbody><br/></table><br/></div><br/>但是这个结构体没有定义确切的地址结构，因此，派生出了 struct sockaddr_in<br/><div style="font-size: 12px; line-height: 12px; font-family: courier new;"><br/><table style="width: 100%; border: 0px; padding: 0px;" cellspacing="0"><br/><tbody><br/><tr><br/><td style="color: teal;" valign="top">1</td><br/><td><strong><span style="color: #0000ff;">struct</span></strong><span style="color: #000000;"> </span><span style="color: #000000;">sockaddr_in</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">2</td><br/><td><span style="color: #000000;">{</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">3</td><br/><td><span style="color: #000000;">sa_family_t</span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;">sin_family;</span><span style="color: #008000;">//</span><span style="color: #008000;">地址族</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">4</td><br/><td><strong><span style="color: #0000ff;">unsigned</span></strong><span style="color: #000000;"> </span><strong><span style="color: #0000ff;">short</span></strong><span style="color: #000000;"> </span><strong><span style="color: #0000ff;">int</span></strong><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;">sin_port;</span><span style="color: #008000;">//</span><span style="color: #008000;">端口号</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">5</td><br/><td><strong><span style="color: #0000ff;">struct</span></strong><span style="color: #000000;"> </span><span style="color: #000000;">in_addr</span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;">sin_addr;</span><span style="color: #008000;">//</span><span style="color: #008000;">地址</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">6</td><br/><td><strong><span style="color: #0000ff;">unsigned</span></strong><span style="color: #000000;"> </span><strong><span style="color: #0000ff;">char</span></strong><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;"> </span><span style="color: #000000;">sin_zero[</span><span style="color: #ff0000;">*</span><span style="color: #ff0000;">*</span><span style="color: #ff0000;">*</span><span style="color: #ff0000;">*</span><span style="color: #ff0000;">*</span><span style="color: #000000;">]</span><span style="color: #008000;">//</span><span style="color: #008000;">这个一般不用，不详细写了</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">7</td><br/><td><span style="color: #000000;">}</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">8</td><br/><td><span style="color: #008000;">//</span><span style="color: #008000;">其中，struct</span><span style="color: #008000;"> </span><span style="color: #008000;">in_addr为</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">9</td><br/><td><strong><span style="color: #0000ff;">struct</span></strong><span style="color: #000000;"> </span><span style="color: #000000;">in_addr</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">10</td><br/><td><span style="color: #000000;">{</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">11</td><br/><td><span style="color: #000000;">__32</span><span style="color: #000000;"> </span><span style="color: #000000;">s_addr;</span></td><br/></tr><br/><tr><br/><td style="color: teal;" valign="top">12</td><br/><td><span style="color: #000000;">}</span></td><br/></tr><br/></tbody><br/></table><br/></div><br/>注：<br/><br/>1.IP地址存放在 sin_addr.s_addr内；<br/><br/>2.地址和端口号都是<a href="http://blog.chinaunix.net/u3/114782/showart.php?id=2235146">网络字节序</a><br/><p style="margin: 5px; line-height: 150%;">二.套接字上的操作：</p><br/><p style="margin: 5px; line-height: 150%;">套接字接口上的系统调用</p><br/><br/><table style="width: 519px; height: 282px;" border="1" cellspacing="1" cellpadding="1"><br/><tbody><br/><tr><br/><td>过 程</td><br/><td>客户端</td><br/><td>服务器</td><br/></tr><br/><tr><br/><td>向系统注册一个socket，操作结果返回套接字描述符，以后的操作需要使用这个描述符</td><br/><td>socket()</td><br/><td>socket()</td><br/></tr><br/><tr><br/><td style="vertical-align: top;">绑定地址，想套接字分配一个本地地址</td><br/><td style="vertical-align: top; background-color: #ffff80;">bind()</td><br/><td style="vertical-align: top;">bind（）</td><br/></tr><br/><tr><br/><td>服务器监听有没有连接请求，目前仅在TCP协议中使用</td><br/><td></td><br/><td style="background-color: #999902;">listen（）</td><br/></tr><br/><tr><br/><td>客户端建立连接，服务器接受连接。connect的作用是为发送的包指定目标地址。</td><br/><td style="background-color: #999902;">connect()</td><br/><td style="background-color: #999902;">accept（）</td><br/></tr><br/><tr><br/><td>数据交换</td><br/><td>write（）|read()</td><br/><td>write（）|read()</td><br/></tr><br/><tr><br/><td>数据交换</td><br/><td>send()|recv()</td><br/><td>send()|recv()</td><br/></tr><br/><tr><br/><td>数据交换 这两个函数要求对所有发送的数据指定目标地址，为所有接受的数据制定来源地址。</td><br/><td>sendto()|recvfrom()</td><br/><td>sendto()|recvfrom()</td><br/></tr><br/><tr><br/><td>数据交换</td><br/><td>writev()|readv()</td><br/><td>writev()|readv()</td><br/></tr><br/><tr><br/><td>数据交换</td><br/><td>sendmsg()|recvmsg()</td><br/><td>sendmsg()|recvmsg()</td><br/></tr><br/><tr><br/><td>关闭连接 close可以关闭连接，也可以关闭套接字描述符</td><br/><td>close()</td><br/><td>close()</td><br/></tr><br/></tbody><br/></table><br/><span style="color: #ff0102;"><br/>注：</span> <br style="color: #ff0102;" /><span style="color: #ff0102;">1.黄色的 可选函数</span> <br style="color: #ff0102;" /><span style="color: #ff0102;">2.灰色的 使用UDP协议时不使用</span><br/><span style="color: #ff0102;">3.当服务器已经收到连接请求的前提下，accept才接受连接。</span>

