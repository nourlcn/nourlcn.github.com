--- 
title: !binary |
  TGludXjlhoXmoLjkuK1zb2NrZXTosIPnlKjlhbPns7s=

type: post
layout: post
tags: 
- Code
- Kernel
---
<br />说明：所有函数原型及代码来自 函数原型[来自LXR.linux.no 内核2.6.34]网络应用程序调用socket()向系统注册套接字,才能进行通信,应用程序中通过系统调用进入内核,在内核中,网络模块的 socket调用关系为:<br /><br /><span style="font-family: 'Courier New'; font-size: small;">应用程序: socket()<br />-------------|---------------------------<br />内核:    sys_socketcall()  // net/socket.c 中<br />|<br />switch(call):<br />---|-------|-------|--------|---------|--判断应用层调用哪个函数<br />[socket() bind() listen() accept() connect()]<br />|<br />sys_socket(int family,int type,int protocal)<br />{<br />声明sock<br />sys_create(family,type,protocol,&sock);//sock是INET层的socket结构<br />sock_map_fd();<br />sock_release();<br />}</span><br /><br /><span style="font-family: 'Courier New'; font-size: small;">sys_create()<br />|<br />调用<br />|<br />sock_create(family,type,protocal等参数)<br />{<br />sock = sock_alloc(); //取得inode，并初始化<br />sock->type = type;//设置sock类型<br />net_families[family]->create<br />}</span><br /><br /><span style="font-size: small;"><span style="font-family: 'Courier New';">sock_alloc()         net_families[family]->create<br />|                        |<br />调用                 inet6_create<br />|<br />inet_create() //TCP/IP协议会调用inet_create() //net/ipv4/af_inet.c<br /></span></span><br /><br /><br />原型:<br /><div style="font-family: courier new; font-size: 12px; line-height: 12px;"><br /><table cellspacing="0" style="border-width: 0px; padding: 0px; width: 100%;"><tbody><tr> <td style="color: teal;" valign="top">1</td> <td><span style="color: black;">inet_create(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">net</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">net,</span><span style="color: black;"> </span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">socket</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">sock,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">protocol,</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">kern)</span></td> </tr></tbody> </table><br /></div><br /><span style="font-size: small;">注:<br />1)调用sys_socketcall传入三个参数(,,call),通过对switch(call)语句判断应用程序要执行哪个系统调用 socket()bind()listen()accept()connect()</span><br /><div style="font-family: courier new; font-size: 12px; line-height: 12px;"><br /><table cellspacing="0" style="border-width: 0px; padding: 0px; width: 100%;"><tbody><tr> <td style="color: teal;" valign="top">1</td> <td><strong><span style="color: teal;">639</span></strong><span style="color: black;"> </span><span style="color: black;">asmlinkage</span><span style="color: black;"> </span><strong><span style="color: blue;">long</span></strong><span style="color: black;"> </span><span style="color: black;">sys_socketcall(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">call,</span><span style="color: black;"> </span><strong><span style="color: blue;">unsigned</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">long</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">args);</span><span style="color: green;">//</span><span style="color: green;">参数call决定调用哪一个函数</span></td></tr></tbody></table><br /></div><div style="font-family: courier new; font-size: 12px; line-height: 12px;"><table cellspacing="0" style="border-width: 0px; padding: 0px; width: 100%;"><tbody><tr> <td><strong><span style="color: blue;"> switch</span></strong><span style="color: black;"> </span><span style="color: black;">(call)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2254</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_SOCKET</span><span style="color: red;">:</span><span style="color: black;"> </span><span style="color: green;">//</span><span style="color: green;">socket()调用</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2255</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_socket(a0,</span><span style="color: black;"> </span><span style="color: black;">a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2256</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2257</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_BIND</span><span style="color: red;">:</span><span style="color: green;">//</span><span style="color: green;">bind()调用</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2258</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_bind(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2259</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2260</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_CONNECT</span><span style="color: red;">:</span><span style="color: green;">//</span><span style="color: green;">connect()</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2261</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_connect(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2262</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2263</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_LISTEN</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2264</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_listen(a0,</span><span style="color: black;"> </span><span style="color: black;">a1);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2265</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2266</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_ACCEPT</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2267</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_accept4(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2268</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><strong><span style="color: teal;">0</span></strong><span style="color: black;">);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2269</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2270</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_GETSOCKNAME</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2271</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2272</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">sys_getsockname(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2273</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2274</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2275</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_GETPEERNAME</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2276</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2277</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">sys_getpeername(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2278</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2279</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2280</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_SOCKETPAIR</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2281</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_socketpair(a0,</span><span style="color: black;"> </span><span style="color: black;">a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2282</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2283</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_SEND</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2284</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_send(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">void</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2285</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2286</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_SENDTO</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2287</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_sendto(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">void</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">],</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2288</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">4</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">5</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2289</span></strong><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2290</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_RECV</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2291</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_recv(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">void</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2292</span></strong><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2293</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_RECVFROM</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2294</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_recvfrom(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">void</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">],</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2295</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">4</span></strong><span style="color: black;">],</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2296</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">5</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2297</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2298</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_SHUTDOWN</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2299</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_shutdown(a0,</span><span style="color: black;"> </span><span style="color: black;">a1);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2300</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2301</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_SETSOCKOPT</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2302</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_setsockopt(a0,</span><span style="color: black;"> </span><span style="color: black;">a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">char</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">4</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2303</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2304</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_GETSOCKOPT</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2305</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2306</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">sys_getsockopt(a0,</span><span style="color: black;"> </span><span style="color: black;">a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">char</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">],</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2307</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">4</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2308</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2309</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_SENDMSG</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2310</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_sendmsg(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">msghdr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2311</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2312</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_RECVMSG</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2313</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_recvmsg(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">msghdr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2314</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2315</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_RECVMMSG</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2316</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_recvmmsg(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">mmsghdr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">],</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2317</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">timespec</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">4</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2318</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2319</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">case</span></strong><span style="color: black;"> </span><span style="color: black;">SYS_ACCEPT4</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2320</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sys_accept4(a0,</span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sockaddr</span><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a1,</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2321</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__user</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">)a[</span><strong><span style="color: teal;">2</span></strong><span style="color: black;">],</span><span style="color: black;"> </span><span style="color: black;">a[</span><strong><span style="color: teal;">3</span></strong><span style="color: black;">]);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2322</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2323</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">default</span></strong><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2324</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: red;">-</span><span style="color: black;">EINVAL;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2325</span></strong><span style="color: black;"> </span><span style="color: black;"> </span><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">2326</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td></td> </tr><tr> <td><span style="color: black;"> </span></td> </tr><tr> <td><span style="color: black;">asmlinkage</span><span style="color: black;"> </span><strong><span style="color: blue;">long</span></strong><span style="color: black;"> </span><span style="color: black;">sys_socket(</span><strong><span style="color: blue;">int</span></strong><span style="color: black;">,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;">,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;">);</span><span style="color: black;"> </span></td> </tr><tr> <td></td> </tr><tr> <td><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: blue;">static</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">__sock_create(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">net</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">net,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">family,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">type,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">protocol,</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">socket</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: red;">*</span><span style="color: black;">res,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">kern)</span><span style="color: black;"> </span></td> </tr><tr> <td></td> </tr><tr> <td><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: blue;">static</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">inet_create(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">net</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">net,</span><span style="color: black;"> </span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">socket</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">sock,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">protocol,</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">kern)</span><span style="color: black;"> </span></td> </tr><tr> <td></td> </tr><tr> <td><span style="color: black;"> </span></td> </tr><tr> <td><span style="color: green;">/*</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">263</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">创建一个inet层的socket结构</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">264</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: blue;">static</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">inet_create(</span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">net</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">net,</span><span style="color: black;"> </span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">socket</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">sock,</span><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">protocol,</span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">kern)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">268</span></strong><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">269</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">sock</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">sk;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">270</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">inet_protosw</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">answer;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">271</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">inet_sock</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">inet;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">272</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">struct</span></strong><span style="color: black;"> </span><span style="color: black;">proto</span><span style="color: black;"> </span><span style="color: red;">*</span><span style="color: black;">answer_prot;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">273</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">unsigned</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">char</span></strong><span style="color: black;"> </span><span style="color: black;">answer_flags;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">274</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">char</span></strong><span style="color: black;"> </span><span style="color: black;">answer_no_check;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">275</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">try_loading_module</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">0</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">276</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">int</span></strong><span style="color: black;"> </span><span style="color: black;">err;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">277</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">278</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(unlikely(</span><span style="color: red;">!</span><span style="color: black;">inet_ehash_secret))</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">279</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">type</span><span style="color: black;"> </span><span style="color: red;">!</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">SOCK_RAW</span><span style="color: black;"> </span><span style="color: red;">&</span><span style="color: red;">&</span><span style="color: black;"> </span><span style="color: black;">sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">type</span><span style="color: black;"> </span><span style="color: red;">!</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">SOCK_DGRAM)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">280</span></strong><span style="color: black;"> </span><span style="color: black;">build_ehash_secret();</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">281</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">282</span></strong><span style="color: black;"> </span><span style="color: black;">sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">state</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">SS_UNCONNECTED;</span><span style="color: black;"> </span><span style="color: green;">//</span><span style="color: green;">设置sock的状态</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">283</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">284</span></strong><span style="color: black;"> </span><span style="color: green;">/*</span><span style="color: green;"> </span><span style="color: green;">Look</span><span style="color: green;"> </span><span style="color: green;">for</span><span style="color: green;"> </span><span style="color: green;">the</span><span style="color: green;"> </span><span style="color: green;">requested</span><span style="color: green;"> </span><span style="color: green;">type/protocol</span><span style="color: green;"> </span><span style="color: green;">pair.</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">285</span></strong><span style="color: black;"> </span><span style="color: black;">lookup_protocol</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">286</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: red;">-</span><span style="color: black;">ESOCKTNOSUPPORT;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">287</span></strong><span style="color: black;"> </span><span style="color: black;">rcu_read_lock();</span><span style="color: green;">//</span><span style="color: green;">读锁</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">288</span></strong><span style="color: black;"> </span><span style="color: black;">list_for_each_entry_rcu(answer,</span><span style="color: black;"> </span><span style="color: red;">&</span><span style="color: black;">inetsw[sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">type],</span><span style="color: black;"> </span><span style="color: black;">list)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">289</span></strong><span style="color: black;"> </span><span style="color: green;">//</span><span style="color: green;">找到属于sock->type的head位置，并将inetsw结构暂存在answer指针中</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">290</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">0</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">291</span></strong><span style="color: black;"> </span><span style="color: green;">/*</span><span style="color: green;"> </span><span style="color: green;">Check</span><span style="color: green;"> </span><span style="color: green;">the</span><span style="color: green;"> </span><span style="color: green;">non-wild</span><span style="color: green;"> </span><span style="color: green;">match.</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">292</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(protocol</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">protocol)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">293</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(protocol</span><span style="color: black;"> </span><span style="color: red;">!</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">IPPROTO_IP)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">294</span></strong><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">295</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span><strong><span style="color: blue;">else</span></strong><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">296</span></strong><span style="color: black;"> </span><span style="color: green;">/*</span><span style="color: green;"> </span><span style="color: green;">Check</span><span style="color: green;"> </span><span style="color: green;">for</span><span style="color: green;"> </span><span style="color: green;">the</span><span style="color: green;"> </span><span style="color: green;">two</span><span style="color: green;"> </span><span style="color: green;">wild</span><span style="color: green;"> </span><span style="color: green;">cases.</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">297</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(IPPROTO_IP</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">protocol)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">298</span></strong><span style="color: black;"> </span><span style="color: black;">protocol</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">protocol;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">299</span></strong><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">300</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">301</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(IPPROTO_IP</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">protocol)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">302</span></strong><span style="color: black;"> </span><strong><span style="color: red;">break</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">303</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">304</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: red;">-</span><span style="color: black;">EPROTONOSUPPORT;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">305</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">306</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">307</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(unlikely(err))</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">308</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(try_loading_module</span><span style="color: black;"> </span><span style="color: red;"><</span><span style="color: black;"> </span><strong><span style="color: teal;">2</span></strong><span style="color: black;">)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">309</span></strong><span style="color: black;"> </span><span style="color: black;">rcu_read_unlock();</span><span style="color: green;">//</span><span style="color: green;">解锁</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">310</span></strong><span style="color: black;"> </span><span style="color: green;">/*</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">311</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">Be</span><span style="color: green;"> </span><span style="color: green;">more</span><span style="color: green;"> </span><span style="color: green;">specific,</span><span style="color: green;"> </span><span style="color: green;">e.g.</span><span style="color: green;"> </span><span style="color: green;">net-pf-2-proto-132-type-1</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">312</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">(net-pf-PF_INET-proto-IPPROTO_SCTP-type-SOCK_STREAM)</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">313</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">314</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(</span><span style="color: red;">+</span><span style="color: red;">+</span><span style="color: black;">try_loading_module</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">1</span></strong><span style="color: black;">)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">315</span></strong><span style="color: black;"> </span><span style="color: black;">request_module(</span><span style="color: teal;">"</span><span style="color: teal;">net-pf-%d-proto-%d-type-%d</span><span style="color: teal;">"</span><span style="color: black;">,</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">316</span></strong><span style="color: black;"> </span><span style="color: black;">PF_INET,</span><span style="color: black;"> </span><span style="color: black;">protocol,</span><span style="color: black;"> </span><span style="color: black;">sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">type);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">317</span></strong><span style="color: black;"> </span><span style="color: green;">/*</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">318</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">Fall</span><span style="color: green;"> </span><span style="color: green;">back</span><span style="color: green;"> </span><span style="color: green;">to</span><span style="color: green;"> </span><span style="color: green;">generic,</span><span style="color: green;"> </span><span style="color: green;">e.g.</span><span style="color: green;"> </span><span style="color: green;">net-pf-2-proto-132</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">319</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">(net-pf-PF_INET-proto-IPPROTO_SCTP)</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">320</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">321</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">else</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">322</span></strong><span style="color: black;"> </span><span style="color: black;">request_module(</span><span style="color: teal;">"</span><span style="color: teal;">net-pf-%d-proto-%d</span><span style="color: teal;">"</span><span style="color: black;">,</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">323</span></strong><span style="color: black;"> </span><span style="color: black;">PF_INET,</span><span style="color: black;"> </span><span style="color: black;">protocol);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">324</span></strong><span style="color: black;"> </span><strong><span style="color: red;">goto</span></strong><span style="color: black;"> </span><span style="color: black;">lookup_protocol;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">325</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span><strong><span style="color: blue;">else</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">326</span></strong><span style="color: black;"> </span><strong><span style="color: red;">goto</span></strong><span style="color: black;"> </span><span style="color: black;">out_rcu_unlock;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">327</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">328</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">329</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: red;">-</span><span style="color: black;">EPERM;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">330</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">type</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">SOCK_RAW</span><span style="color: black;"> </span><span style="color: red;">&</span><span style="color: red;">&</span><span style="color: black;"> </span><span style="color: red;">!</span><span style="color: black;">kern</span><span style="color: black;"> </span><span style="color: red;">&</span><span style="color: red;">&</span><span style="color: black;"> </span><span style="color: red;">!</span><span style="color: black;">capable(CAP_NET_RAW))</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">331</span></strong><span style="color: black;"> </span><strong><span style="color: red;">goto</span></strong><span style="color: black;"> </span><span style="color: black;">out_rcu_unlock;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">332</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">333</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: red;">-</span><span style="color: black;">EAFNOSUPPORT;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">334</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(</span><span style="color: red;">!</span><span style="color: black;">inet_netns_ok(net,</span><span style="color: black;"> </span><span style="color: black;">protocol))</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">335</span></strong><span style="color: black;"> </span><strong><span style="color: red;">goto</span></strong><span style="color: black;"> </span><span style="color: black;">out_rcu_unlock;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">336</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">337</span></strong><span style="color: black;"> </span><span style="color: black;">sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">ops</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">ops;</span><span style="color: black;"> </span><span style="color: green;">//</span><span style="color: green;">inet所使用的函数名称</span><span style="color: green;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">338</span></strong><span style="color: black;"> </span><span style="color: black;">answer_prot</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">prot;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">339</span></strong><span style="color: black;"> </span><span style="color: black;">answer_no_check</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">no_check;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">340</span></strong><span style="color: black;"> </span><span style="color: black;">answer_flags</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">flags;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">341</span></strong><span style="color: black;"> </span><span style="color: black;">rcu_read_unlock();</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">342</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">343</span></strong><span style="color: black;"> </span><span style="color: black;">WARN_ON(answer_prot</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">slab</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: blue;">NULL</span></strong><span style="color: black;">);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">344</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">345</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: red;">-</span><span style="color: black;">ENOBUFS;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">346</span></strong><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sk_alloc(net,</span><span style="color: black;"> </span><span style="color: black;">PF_INET,</span><span style="color: black;"> </span><span style="color: black;">GFP_KERNEL,</span><span style="color: black;"> </span><span style="color: black;">answer_prot);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">347</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(sk</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: blue;">NULL</span></strong><span style="color: black;">)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">348</span></strong><span style="color: black;"> </span><strong><span style="color: red;">goto</span></strong><span style="color: black;"> </span><span style="color: black;">out;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">349</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">350</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">0</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">351</span></strong><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_no_check</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">answer_no_check;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">352</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(INET_PROTOSW_REUSE</span><span style="color: black;"> </span><span style="color: red;">&</span><span style="color: black;"> </span><span style="color: black;">answer_flags)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">353</span></strong><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_reuse</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">1</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">354</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">355</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">inet_sk(sk);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">356</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">is_icsk</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">(INET_PROTOSW_ICSK</span><span style="color: black;"> </span><span style="color: red;">&</span><span style="color: black;"> </span><span style="color: black;">answer_flags)</span><span style="color: black;"> </span><span style="color: red;">!</span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">0</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">357</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">358</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(SOCK_RAW</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sock</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">type)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">359</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">inet_num</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">protocol;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">360</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(IPPROTO_RAW</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">protocol)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">361</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">hdrincl</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">1</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">362</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">363</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">364</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(ipv4_config</span><span style="color: red;">.</span><span style="color: black;">no_pmtu_disc)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">365</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">pmtudisc</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">IP_PMTUDISC_DONT;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">366</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">else</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">367</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">pmtudisc</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">IP_PMTUDISC_WANT;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">368</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">369</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">inet_id</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">0</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">370</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">371</span></strong><span style="color: black;"> </span><span style="color: black;">sock_init_data(sock,</span><span style="color: black;"> </span><span style="color: black;">sk);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">372</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">373</span></strong><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_destruct</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">inet_sock_destruct;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">374</span></strong><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_protocol</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">protocol;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">375</span></strong><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_backlog_rcv</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_prot</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">backlog_rcv;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">376</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">377</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">uc_ttl</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: red;">-</span><strong><span style="color: teal;">1</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">378</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">mc_loop</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">1</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">379</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">mc_ttl</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">1</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">380</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">mc_all</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">1</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">381</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">mc_index</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: teal;">0</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">382</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">mc_list</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><strong><span style="color: blue;">NULL</span></strong><span style="color: black;">;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">383</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">384</span></strong><span style="color: black;"> </span><span style="color: black;">sk_refcnt_debug_inc(sk);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">385</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">386</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">inet_num)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">387</span></strong><span style="color: black;"> </span><span style="color: green;">/*</span><span style="color: green;"> </span><span style="color: green;">It</span><span style="color: green;"> </span><span style="color: green;">assumes</span><span style="color: green;"> </span><span style="color: green;">that</span><span style="color: green;"> </span><span style="color: green;">any</span><span style="color: green;"> </span><span style="color: green;">protocol</span><span style="color: green;"> </span><span style="color: green;">which</span><span style="color: green;"> </span><span style="color: green;">allows</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">388</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">the</span><span style="color: green;"> </span><span style="color: green;">user</span><span style="color: green;"> </span><span style="color: green;">to</span><span style="color: green;"> </span><span style="color: green;">assign</span><span style="color: green;"> </span><span style="color: green;">a</span><span style="color: green;"> </span><span style="color: green;">number</span><span style="color: green;"> </span><span style="color: green;">at</span><span style="color: green;"> </span><span style="color: green;">socket</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">389</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">creation</span><span style="color: green;"> </span><span style="color: green;">time</span><span style="color: green;"> </span><span style="color: green;">automatically</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">390</span><span style="color: green;"> </span><span style="color: green;">*</span><span style="color: green;"> </span><span style="color: green;">shares.</span><span style="color: green;"> </span></td> </tr><tr> <td><span style="color: green;">391</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">392</span></strong><span style="color: black;"> </span><span style="color: black;">inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">inet_sport</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">htons(inet</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">inet_num);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">393</span></strong><span style="color: black;"> </span><span style="color: green;">/*</span><span style="color: green;"> </span><span style="color: green;">Add</span><span style="color: green;"> </span><span style="color: green;">to</span><span style="color: green;"> </span><span style="color: green;">protocol</span><span style="color: green;"> </span><span style="color: green;">hash</span><span style="color: green;"> </span><span style="color: green;">chains.</span><span style="color: green;"> </span><span style="color: green;">*/</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">394</span></strong><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_prot</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">hash(sk);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">395</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">396</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">397</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_prot</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">init)</span><span style="color: black;"> </span><span style="color: black;">{</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">398</span></strong><span style="color: black;"> </span><span style="color: black;">err</span><span style="color: black;"> </span><span style="color: red;">=</span><span style="color: black;"> </span><span style="color: black;">sk</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">sk_prot</span><span style="color: red;">-</span><span style="color: red;">></span><span style="color: black;">init(sk);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">399</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">if</span></strong><span style="color: black;"> </span><span style="color: black;">(err)</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">400</span></strong><span style="color: black;"> </span><span style="color: black;">sk_common_release(sk);</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">401</span></strong><span style="color: black;"> </span><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><span style="color: black;">402out</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">403</span></strong><span style="color: black;"> </span><strong><span style="color: blue;">return</span></strong><span style="color: black;"> </span><span style="color: black;">err;</span><span style="color: black;"> </span></td> </tr><tr> <td><span style="color: black;">404out_rcu_unlock</span><span style="color: red;">:</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">405</span></strong><span style="color: black;"> </span><span style="color: black;">rcu_read_unlock();</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">406</span></strong><span style="color: black;"> </span><strong><span style="color: red;">goto</span></strong><span style="color: black;"> </span><span style="color: black;">out;</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">407</span></strong><span style="color: black;">}</span><span style="color: black;"> </span></td> </tr><tr> <td><strong><span style="color: teal;">408</span></strong><span style="color: black;"> </span></td> </tr><tr> <td><span style="color: black;"> </span></td> </tr><tr> <td></td> </tr></tbody> </table><br /></div>

