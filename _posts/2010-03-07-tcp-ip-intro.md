---
title: 内核中的TCP IP协议
type: post
layout: post
tags:
- TCP
---

<span style="font-size: small;">TCP/IP协议簇共有五个层次（或四个层次：将物理层和数据链路层合称为链路层），如图</span><br/><br/><span style="font-size: small;"><a href="http://u.ownlinux.net/nourl/wp-content/uploads/2010/03/tcp-ip.gif"><img class="alignnone size-medium wp-image-39028" title="tcp-ip" src="http://u.ownlinux.net/nourl/wp-content/uploads/2010/03/tcp-ip-300x268.gif" alt="" width="300" height="268" /></a><br/></span><br/><br/><span style="font-size: small;">应用层：直接为网络应用提供服务</span><br/><br/><span style="font-size: small;">传输层：向应用层提供服务，主要有TCP（面向连接）和UDP（无连接）两种协议。在TCP/IP协议簇中，该层主要负责</span><br/><br/><span style="font-size: small;">0.“面向连接”还是“无连接”</span><br/><br/><span style="font-size: small;">1.“可靠的”还是“不可靠”</span><br/><br/><span style="font-size: small;">2.安全</span><br/><br/><span style="font-size: small;">网络层：提供无连接的服务。该层主要负责对数据包的转发和路由（IP协议）和错误处理（ICMP==Internet 控制消息协议）</span><br/><br/><span style="font-size: small;">数据链路层：负责在物理媒介中传输数据包。</span><br/><br/><span style="font-size: small;"><br/></span><br/><p style="font-weight: bold;"><span style="font-size: medium;">IP头部分析：</span></p><br/><span style="font-size: small;"><img src="http://u.ownlinux.net/media/aglsZWVqaW5ndWlyDAsSBU1lZGlhGKlGDA/IP-e.jpg" alt="" /></span><br/><br/><span style="font-size: small;">IPv4数据报由IP头（20B定长部分+可选的变长部分）+数据组成，IPv4头部传输采用BIG-endian字节序，从左到右，高字节先传输，整数的高位存放在内存较低的存储地址。</span><br/><br/><span style="font-size: small;">版本：指明版本号，对于IPv4该值为4</span><br/><br/><span style="font-size: small;">头长度：以4B为单位，最小值是5，这样IPv4头最小就是20B的长度，头长度这一段是4bit，最大值是15，因此，IPv4头部的最大长度是15×4=60B，因此，可选的选项+填充部分加和不超过40B。</span><br/><br/><span style="font-size: small;">服务类型（TOS）：共8bit，目前使用前6bit ，表示数据报属于类别中的哪一类，这些类别包括：4个排队优先级，3中丢弃可能性，和一些历史类别。</span><br/><br/><span style="font-size: small;">总长度：指分段后每片的头长度+数据长度的总和。</span><br/><br/><span style="font-size: small;">标识：本段的作用是使分段后的个数据报片能够准确的重组成分段前的数据报</span><br/><br/><span style="font-size: small;">标志：3bit，目前使用后2bit 。最低位为MF(MF=1,表示后面还有分段的数据报，MF=0表示这是分段的最后一片) 。中间一位为DF（DF=0表示允许分段，DF=1表示不允许分段）</span><br/><br/><span style="font-size: small;">分段偏移：以8B为单位，指出分段在原来分组中的位置</span><br/><br/><span style="font-size: small;">生存期（TTL）：防止数据报在传输过程中产生路由循环，没经过一个路由，TTL的值-1</span><br/><br/><span style="font-size: small;">协议：指出数据报携带的传输层数据使用什么协议，在数据到达目的主机的网络层时，交付给传输层相应的接口</span><br/><br/><span style="font-size: small;">头部校验和：简单的校验结果，保证头部的完整性</span><br/><br/><span style="font-size: small;">源地址和目的地址：数据的发送发OP地址和目的主机IP</span><br/><br/><span style="font-size: small;">选项：可选，承载额外信息<br/></span>

