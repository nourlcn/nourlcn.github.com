--- 
title: !binary |
  TmV0ZmlsdGVy5L2T57O757uT5p6ELeWGheaguOS4reeahCBOZXRmaWx0ZXLm
  oYbmnrY=

type: post
layout: post
tags: 
- Code
- Kernel
---
<span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">一.通用防火墙简介：</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">   Linux上的防火墙一般是通过Netfilter来实现对包的有规则的过滤，防火墙模块在Linux上注册成为/dev的一个字符设备，通过ioctl()设置过滤规则，在5个HOOK（ipv4中是5个）钓鱼点设置钩子函数，一般设置规则是通过设置相关的（源IP，源PORT，目的IP，目的IP）来实现。</span><br /><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">二.Netfilter：</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">  Netfilter是一个框架，可以实现包过滤，NAT（net addr trans 网络地址转换），网络连接跟踪等功能。</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">在IPV4中有5个HOOK点，我们称为钓鱼点，因为在这些地方，可以设置钩子函数（鱼钩）来获取符合条件的数据包（鱼）。5个HOOK点如下：</span><br /><br /><table border="1" cellpadding="1" cellspacing="1" style="background-color: #dee8e5; color: black; font-family: 宋体, Arial; height: 173px; line-height: 15px; width: 550px;"><tbody><tr><td style="line-height: 1.5; vertical-align: top;">  HOOK点</td><td style="line-height: 1.5; vertical-align: top;">           说 明</td><td style="line-height: 1.5; vertical-align: top;"> 函数位置</td><td style="line-height: 1.5; vertical-align: top;"> 应用举例 </td></tr><tr><td style="line-height: 1.5;"> NF_IP_PRE_ROUTING</td><td style="line-height: 1.5;">  由网卡传入主机的数据包，在没有经过IP层路由之前，会先经过这个点</td><td style="line-height: 1.5;"> ip_rcv()</td><td style="line-height: 1.5; vertical-align: top;">过滤拒绝服务攻击NAT计算</td></tr><tr><td style="line-height: 1.5; vertical-align: top;"> NF_IP_LOCAL_IN</td><td style="line-height: 1.5; vertical-align: top;">  经过路由选择，要进入本机的数据包，会经过这个点</td><td style="line-height: 1.5; vertical-align: top;"><br />ip_local_deliver()<br />在此处可进行碎片重组</td><td style="line-height: 1.5; vertical-align: top;">防火墙过滤进入本机的包</td></tr><tr><td style="line-height: 1.5;"> NF_IP_FORWARD</td><td style="line-height: 1.5;">  经过路由，不是发往本机的包，需要向外发送，会经过这个点</td><td style="line-height: 1.5;">ip_forward()<br />之后进入ip_send()</td><td style="line-height: 1.5; vertical-align: top;"><br /></td></tr><tr><td style="line-height: 1.5;"> NF_IP_LOCAL_OUT</td><td style="line-height: 1.5;">  本机发往外部的数据包在经过路由之前会经过这个点</td><td style="line-height: 1.5;">ip_build_and_send_pkt()<br />ip_queue_xmit（）<br />ip_build_xmit_slow（）<br />ip_buid_xmit（）<br />不同的上层协议会走不同的流程</td><td style="line-height: 1.5; vertical-align: top;">防火墙过滤外发的数据包</td></tr><tr><td style="line-height: 1.5;"> NF_IP_POST_ROUTING<br />所有外出包都必须经过的钩子点</td><td style="line-height: 1.5;">  本机发送出去的包，在路由后会经过此点</td><td style="line-height: 1.5;"><br />ip_finish_output()</td><td style="line-height: 1.5; vertical-align: top;">  包计数功能实现</td></tr></tbody></table><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">数据流描述：</span><br /><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">简单的校验</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">NF_IP_PRE_ROUTING-></span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">   路由</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">  发往本机--->发往外部->NF_IP_FORWARD---->NF_IP_POST_ROUTING</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;"> NF_IP_LOCAL_IN</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">高层的协议及进程</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">   发包</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">NF_IP_LOCAL_OUT</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">   路由</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">    |</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">NF_IP_POST_ROUTING   </span><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">                               </span><br /><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">HOOK函数的返回值</span><br /><br /><table bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" style="background-color: #dee8e5; border-collapse: collapse; color: black; font-family: 宋体, Arial; line-height: 15px;"><tbody><tr><td style="line-height: 1.5;"><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;"><span style="color: #0000cc; line-height: 1.5;">include/linux/netfilter.h</span></span></div>#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_DROP" style="color: #63401b; text-decoration: none;" target="_blank">NF_DROP</a> 0<span style="line-height: 1.5;"><span style="color: red; line-height: 1.5;">//丢弃数据包</span></span><br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L19" name="L19" style="color: #63401b; text-decoration: none;" target="_blank">19</a>#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_ACCEPT" style="color: #63401b; text-decoration: none;" target="_blank">NF_ACCEPT</a> 1<span style="line-height: 1.5;"><span style="color: red; line-height: 1.5;">//允许该数据包继续传递</span></span><br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L20" name="L20" style="color: #63401b; text-decoration: none;" target="_blank">20</a>#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_STOLEN" style="color: #63401b; text-decoration: none;" target="_blank">NF_STOLEN</a> 2<span style="line-height: 1.5;"><span style="color: red; line-height: 1.5;">//接收该数据包，但不再传递，可以用于包的分片重组。</span></span><br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L21" name="L21" style="color: #63401b; text-decoration: none;" target="_blank">21</a>#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_QUEUE" style="color: #63401b; text-decoration: none;" target="_blank">NF_QUEUE</a> 3<span style="line-height: 1.5;"><span style="color: red; line-height: 1.5;">//将此数据包放入一特定队列，通常用于用户空间的处理。</span></span><br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L22" name="L22" style="color: #63401b; text-decoration: none;" target="_blank">22</a>#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_REPEAT" style="color: #63401b; text-decoration: none;" target="_blank">NF_REPEAT</a> 4<span style="line-height: 1.5;"><span style="color: red; line-height: 1.5;">//再次调用HOOK函数</span></span><br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L23" name="L23" style="color: #63401b; text-decoration: none;" target="_blank">23</a>#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_STOP" style="color: #63401b; text-decoration: none;" target="_blank">NF_STOP</a> 5<br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L24" name="L24" style="color: #63401b; text-decoration: none;" target="_blank">24</a>#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_MAX_VERDICT" style="color: #63401b; text-decoration: none;" target="_blank">NF_MAX_VERDICT</a> <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_STOP" style="color: #63401b; text-decoration: none;" target="_blank">NF_STOP</a></td></tr></tbody></table><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">nf_hook_ops数据结构： </span><br /><br /><table bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" style="background-color: #dee8e5; border-collapse: collapse; color: black; font-family: 宋体, Arial; line-height: 15px;"><tbody><tr><td style="line-height: 1.5;"><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;">include/linux/netfilter.h</div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;"><span style="color: blue; line-height: 1.5;">     struct</span> nf_hook_ops <span style="color: #0000cc; line-height: 1.5;">{</span><br />  97 <span style="color: blue; line-height: 1.5;">struct</span> list_head <span style="color: red; line-height: 1.5;">list</span><span style="color: #0000cc; line-height: 1.5;">; //用于维护NF的HOOK列表</span><br />  98<br />  99 <span style="color: #ff9900; line-height: 1.5;">/* 下面的数据需要用户set */</span><br /> 100 nf_hookfn <span style="color: #0000cc; line-height: 1.5;">*</span>hook<span style="color: #0000cc; line-height: 1.5;">;      //hook被调用是执行的函数</span><br /> 101 <span style="color: blue; line-height: 1.5;">struct</span> module <span style="color: #0000cc; line-height: 1.5;">*</span>owner<span style="color: #0000cc; line-height: 1.5;">; //模块的owner</span><br /> 102 u_int8_t pf<span style="color: #0000cc; line-height: 1.5;">;          //</span>制定协议族<br /> 103 <span style="color: blue; line-height: 1.5;">unsigned</span> <span style="color: blue; line-height: 1.5;">int</span> hooknum<span style="color: #0000cc; line-height: 1.5;">; //具体的hook类型</span><br /> 104 <span style="color: #ff9900; line-height: 1.5;">/* Hooks的优先级按递增顺序排列 */</span><br /> 105 <span style="color: blue; line-height: 1.5;">int</span> priority<span style="color: #0000cc; line-height: 1.5;">; //优先级</span><br /> 106<span style="color: #0000cc; line-height: 1.5;">}</span><span style="color: #0000cc; line-height: 1.5;">;</span></span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="font-family: monospace; line-height: 1.5;"><br /></span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="font-family: monospace; line-height: 1.5;">//其中hookfn声明如下：</span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="font-family: monospace; line-height: 1.5;"></span>typedef unsigned int <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dnf_hookfn" style="color: #63401b; text-decoration: none;" target="_blank">nf_hookfn</a>(unsigned int <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dhooknum" style="color: #63401b; text-decoration: none;" target="_blank">hooknum</a>,//具体的hook类型</div><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L91" name="L91" style="color: #63401b; text-decoration: none;" target="_blank">91</a> struct <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dsk_buff" style="color: #63401b; text-decoration: none;" target="_blank">sk_buff</a> *<a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dskb" style="color: #63401b; text-decoration: none;" target="_blank">skb</a>,//socket缓冲区<br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L92" name="L92" style="color: #63401b; text-decoration: none;" target="_blank">92</a> const struct <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dnet_device" style="color: #63401b; text-decoration: none;" target="_blank">net_device</a> *<a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Din" style="color: #63401b; text-decoration: none;" target="_blank">in</a>, //输入设备（收到包的设备net_device指针）<br />                                                                //外发的包为NULL<br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L93" name="L93" style="color: #63401b; text-decoration: none;" target="_blank">93</a> const struct <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dnet_device" style="color: #63401b; text-decoration: none;" target="_blank">net_device</a> *<a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dout" style="color: #63401b; text-decoration: none;" target="_blank">out</a>,//接口（数据包离开所需要的net_device指针）<br /><a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2Finclude%2Flinux%2Fnetfilter.h%23L94" name="L94" style="color: #63401b; text-decoration: none;" target="_blank">94</a> int (*<a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dokfn" style="color: #63401b; text-decoration: none;" target="_blank">okfn</a>)(struct <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dsk_buff" style="color: #63401b; text-decoration: none;" target="_blank">sk_buff</a> *));//okfn，所有注册的hook函数都返回NF_ACCEPT时，调用<br /><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><br /><span style="line-height: 1.5;"><span style="color: #0000cc; line-height: 1.5;"></span></span></div></td></tr></tbody></table><br /><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">三。NF_HOOK宏</span><br /><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">调用该宏将筛选过滤功能的代码连接到NETFILTER中</span><br /><table bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" style="background-color: #dee8e5; border-collapse: collapse; color: black; font-family: 宋体, Arial; line-height: 15px;"><tbody><tr><td style="line-height: 1.5;">#define <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3DNF_HOOK" style="color: #63401b; text-decoration: none;" target="_blank">NF_HOOK</a>(<a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dpf" style="color: #63401b; text-decoration: none;" target="_blank">pf</a>, <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dhook" style="color: #63401b; text-decoration: none;" target="_blank">hook</a>, <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dskb" style="color: #63401b; text-decoration: none;" target="_blank">skb</a>, <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dindev" style="color: #63401b; text-decoration: none;" target="_blank">indev</a>, <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Doutdev" style="color: #63401b; text-decoration: none;" target="_blank">outdev</a>, <a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dokfn" style="color: #63401b; text-decoration: none;" target="_blank">okfn</a>) (<a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dokfn" style="color: #63401b; text-decoration: none;" target="_blank">okfn</a>)(<a href="http://blog.chinaunix.net/link.php?url=http://lxr.linux.no%2Flinux%2B%2A%2F%2Bcode%3Dskb" style="color: #63401b; text-decoration: none;" target="_blank">skb</a>) //pf     协议族<br /> //hook   钩子<br /> //skb    buff结构的指针<br /> //indev  hookfn中的*in<br /> //outdev hookfn中的*out<br /> //okfn</td></tr></tbody></table><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">四。注册Netfilter HOOK函数</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">//此段代码在我的另一片博客中有具体分析</span><a href="http://blog.chinaunix.net/link.php?url=http://goo.gl%2FEWZs" style="background-color: #dee8e5; color: #63401b; font-family: 宋体, Arial; line-height: 15px; text-decoration: none;" target="_blank">http://goo.gl/EWZs</a><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;"> 这里是简单介绍一下。</span><br /><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">（就是向链表中添加一个节点，属性由协议簇和hook类型来确定）</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">首先初始化一个nf_hook_ips节点（见上方的解析）</span><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">struct list_head nf_hooks[NPROTO指定协议族][NF_MAX_HOOKS指定hook类型]</span><br /><br /><br /><table bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" style="background-color: #dee8e5; border-collapse: collapse; color: black; font-family: 宋体, Arial; line-height: 15px;"><tbody><tr><td style="line-height: 1.5;"><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;"><span style="color: blue; line-height: 1.5;">int</span>  nf_register_hook<span style="color: #0000cc; line-height: 1.5;">(</span><span style="color: blue; line-height: 1.5;">struct</span> nf_hook_ops <span style="color: #0000cc; line-height: 1.5;">*</span>reg<span style="color: #0000cc; line-height: 1.5;">)</span><span style="color: #0000cc; line-height: 1.5;">; //</span></span>注册函数   <span style="line-height: 1.5;"><span style="color: #0000cc; line-height: 1.5;"></span><br />void nf_unregister_hook<span style="color: #0000cc; line-height: 1.5;">(</span><span style="color: blue; line-height: 1.5;">struct</span> nf_hook_ops <span style="color: #0000cc; line-height: 1.5;">*</span>reg<span style="color: #0000cc; line-height: 1.5;">)</span><span style="color: #0000cc; line-height: 1.5;">; //</span></span>注册解除函数<span style="line-height: 1.5;"><span style="color: #0000cc; line-height: 1.5;"></span></span></div></td></tr></tbody></table><br /><span style="background-color: #dee8e5; font-family: 宋体, Arial; line-height: 15px;">内核中使用示例</span><br /><br /><table bgcolor="#f1f1f1" border="1" bordercolor="#999999" cellpadding="0" cellspacing="0" style="background-color: #dee8e5; border-collapse: collapse; color: black; font-family: 宋体, Arial; line-height: 15px;"><tbody><tr><td style="line-height: 1.5;"><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;"><span style="color: blue; line-height: 1.5;">//net/netfilter/core.c<br /><span style="font-family: 'Courier New', Courier, 宋体; line-height: 1.5;"><span style="line-height: 1.5; text-decoration: underline;"></span></span></span></span><span style="line-height: 1.5;"></span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;"><span style="color: blue; line-height: 1.5;">     int</span> nf_register_hook<span style="color: #0000cc; line-height: 1.5;">(</span><span style="color: blue; line-height: 1.5;">struct</span> nf_hook_ops <span style="color: #0000cc; line-height: 1.5;">*</span>reg<span style="color: #0000cc; line-height: 1.5;">)</span><br />  60<span style="color: #0000cc; line-height: 1.5;">{</span><br />  61 <span style="color: blue; line-height: 1.5;">struct</span> nf_hook_ops <span style="color: #0000cc; line-height: 1.5;">*</span>elem<span style="color: #0000cc; line-height: 1.5;">; //ops结构</span><br />  62 <span style="color: blue; line-height: 1.5;">int</span> err<span style="color: #0000cc; line-height: 1.5;">; //错误变量</span><br />  63<br />  64 err <span style="color: #0000cc; line-height: 1.5;">=</span> mutex_lock_interruptible<span style="color: #0000cc; line-height: 1.5;">(</span><span style="color: #0000cc; line-height: 1.5;">&</span>nf_hook_mutex<span style="color: #0000cc; line-height: 1.5;">)</span><span style="color: #0000cc; line-height: 1.5;">; //锁互斥量</span><br />  65 <span style="color: blue; line-height: 1.5;">if</span> <span style="color: #0000cc; line-height: 1.5;">(</span>err <span style="color: #0000cc; line-height: 1.5;"><</span> 0<span style="color: #0000cc; line-height: 1.5;">)</span><br />  66  <span style="color: blue; line-height: 1.5;">return</span> err<span style="color: #0000cc; line-height: 1.5;">;</span></span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;"><span style="color: #0000cc; line-height: 1.5;">//根据优先级，将该hook插入合适的位置</span><br />  67 list_for_each_entry<span style="color: #0000cc; line-height: 1.5;">(</span>elem<span style="color: #0000cc; line-height: 1.5;">,</span> <span style="color: #0000cc; line-height: 1.5;">&</span>nf_hooks<span style="color: #0000cc; line-height: 1.5;">[</span>reg<span style="color: #0000cc; line-height: 1.5;">-</span><span style="color: #0000cc; line-height: 1.5;">></span>pf<span style="color: #0000cc; line-height: 1.5;">]</span><span style="color: #0000cc; line-height: 1.5;">[</span>reg<span style="color: #0000cc; line-height: 1.5;">-</span><span style="color: #0000cc; line-height: 1.5;">></span>hooknum<span style="color: #0000cc; line-height: 1.5;">]</span><span style="color: #0000cc; line-height: 1.5;">,</span> <span style="color: red; line-height: 1.5;">list</span><span style="color: #0000cc; line-height: 1.5;">)</span> <span style="color: #0000cc; line-height: 1.5;">{</span><br />  68 <span style="color: blue; line-height: 1.5;">if</span> <span style="color: #0000cc; line-height: 1.5;">(</span>reg<span style="color: #0000cc; line-height: 1.5;">-</span><span style="color: #0000cc; line-height: 1.5;">></span>priority <span style="color: #0000cc; line-height: 1.5;"><</span> elem<span style="color: #0000cc; line-height: 1.5;">-</span><span style="color: #0000cc; line-height: 1.5;">></span>priority<span style="color: #0000cc; line-height: 1.5;">)</span><br />  69 <span style="color: blue; line-height: 1.5;">break</span><span style="color: #0000cc; line-height: 1.5;">;</span><br />  70 <span style="color: #0000cc; line-height: 1.5;">}</span></span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;"><span style="color: #0000cc; line-height: 1.5;">//增加一个节点</span><br />  71 list_add_rcu<span style="color: #0000cc; line-height: 1.5;">(</span><span style="color: #0000cc; line-height: 1.5;">&</span>reg<span style="color: #0000cc; line-height: 1.5;">-</span><span style="color: #0000cc; line-height: 1.5;">></span><span style="color: red; line-height: 1.5;">list</span><span style="color: #0000cc; line-height: 1.5;">,</span> elem<span style="color: #0000cc; line-height: 1.5;">-</span><span style="color: #0000cc; line-height: 1.5;">></span><span style="color: red; line-height: 1.5;">list</span><span style="color: #0000cc; line-height: 1.5;">.</span>prev<span style="color: #0000cc; line-height: 1.5;">)</span><span style="color: #0000cc; line-height: 1.5;">;</span></span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;">//解锁互斥量</span></div><div style="line-height: 21px; margin-bottom: 5px; margin-left: 5px; margin-right: 5px; margin-top: 5px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 5px;"><span style="line-height: 1.5;">  72 mutex_unlock<span style="color: #0000cc; line-height: 1.5;">(</span><span style="color: #0000cc; line-height: 1.5;">&</span>nf_hook_mutex<span style="color: #0000cc; line-height: 1.5;">)</span><span style="color: #0000cc; line-height: 1.5;">;</span><br />  73 <span style="color: blue; line-height: 1.5;">return</span> 0<span style="color: #0000cc; line-height: 1.5;">;</span><br />  74<span style="color: #0000cc; line-height: 1.5;">}</span></span></div></td></tr></tbody></table><br />本文地址：<a href="http://nourlcn.ownlinux.net/2010/05/netfilter-netfilter.html">http://nourlcn.ownlinux.net/2010/05/netfilter-netfilter.html</a><br /><a href="http://blog.chinaunix.net/link.php?url=http://goo.gl%2F3OKQ" style="background-color: #dee8e5; color: #63401b; font-family: 宋体, Arial; font-size: 12px; line-height: 15px; text-decoration: none;" target="_blank"></a>

