--- 
title: My first hook "helloworld"
type: post
layout: post
tags: 
- !binary |
  5pyq5YiG57G7

---
<div style="font-size: 12px; line-height: 12px; font-family: courier new">   <table style="border-right: 0px; padding-right: 0px; border-top: 0px; padding-left: 0px; padding-bottom: 0px; border-left: 0px; width: 100%; padding-top: 0px; border-bottom: 0px" cellspacing="0"><tbody>       <tr>         <td style="color: teal" valign="top">1  </td>          <td><span style="color: #008000">//</span><span style="color: #008000">丢弃所有到达的数据包</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">2  </td>          <td><span style="color: #0000ff">#define</span><span style="color: #000000"> </span><span style="color: #000000">__KERNEL__</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">3  </td>          <td><span style="color: #0000ff">#define</span><span style="color: #000000"> </span><span style="color: #000000">MODULE</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">4  </td>          <td> </td>       </tr>        <tr>         <td style="color: teal" valign="top">5  </td>          <td><span style="color: #0000ff">#include</span><span style="color: #000000"> </span><span style="color: #ff0000"><</span><span style="color: #000000">linux</span><span style="color: #ff0000">/</span><span style="color: #000000">module</span><span style="color: #ff0000">.</span><span style="color: #000000">h</span><span style="color: #ff0000">></span></td>       </tr>        <tr>         <td style="color: teal" valign="top">6  </td>          <td><span style="color: #0000ff">#include</span><span style="color: #000000"> </span><span style="color: #ff0000"><</span><span style="color: #000000">linux</span><span style="color: #ff0000">/</span><span style="color: #000000">kernel</span><span style="color: #ff0000">.</span><span style="color: #000000">h</span><span style="color: #ff0000">></span></td>       </tr>        <tr>         <td style="color: teal" valign="top">7  </td>          <td><span style="color: #0000ff">#include</span><span style="color: #000000"> </span><span style="color: #ff0000"><</span><span style="color: #000000">linux</span><span style="color: #ff0000">/</span><span style="color: #000000">netfilter</span><span style="color: #ff0000">.</span><span style="color: #000000">h</span><span style="color: #ff0000">></span></td>       </tr>        <tr>         <td style="color: teal" valign="top">8  </td>          <td><span style="color: #0000ff">#include</span><span style="color: #000000"> </span><span style="color: #ff0000"><</span><span style="color: #000000">linux</span><span style="color: #ff0000">/</span><span style="color: #000000">netfilter_ipv4</span><span style="color: #ff0000">.</span><span style="color: #000000">h</span><span style="color: #ff0000">></span></td>       </tr>        <tr>         <td style="color: teal" valign="top">9  </td>          <td> </td>       </tr>        <tr>         <td style="color: teal" valign="top">10  </td>          <td><b><span style="color: #0000ff">static</span></b><span style="color: #000000"> </span><b><span style="color: #0000ff">struct</span></b><span style="color: #000000"> </span><span style="color: #000000">nf_hook_ops</span><span style="color: #000000"> </span><span style="color: #000000">nfho;</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">11  </td>          <td> </td>       </tr>        <tr>         <td style="color: teal" valign="top">12  </td>          <td><b><span style="color: #0000ff">unsigned</span></b><span style="color: #000000"> </span><b><span style="color: #0000ff">int</span></b><span style="color: #000000"> </span><span style="color: #000000">hook_func(</span><b><span style="color: #0000ff">unsigned</span></b><span style="color: #000000"> </span><b><span style="color: #0000ff">int</span></b><span style="color: #000000"> </span><span style="color: #000000">hooknum,</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">13  </td>          <td><b><span style="color: #0000ff">struct</span></b><span style="color: #000000"> </span><span style="color: #000000">sk_buff</span><span style="color: #000000"> </span><span style="color: #ff0000">*</span><span style="color: #ff0000">*</span><span style="color: #000000">skb,</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">14  </td>          <td><b><span style="color: #0000ff">const</span></b><span style="color: #000000"> </span><b><span style="color: #0000ff">struct</span></b><span style="color: #000000"> </span><span style="color: #000000">net_device</span><span style="color: #000000"> </span><span style="color: #ff0000">*</span><span style="color: #000000">in,</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">15  </td>          <td><b><span style="color: #0000ff">const</span></b><span style="color: #000000"> </span><b><span style="color: #0000ff">struct</span></b><span style="color: #000000"> </span><span style="color: #000000">net_device</span><span style="color: #000000"> </span><span style="color: #ff0000">*</span><span style="color: #000000">out,</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">16  </td>          <td><b><span style="color: #0000ff">int</span></b><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #ff0000">*</span><span style="color: #000000">okfn)(</span><b><span style="color: #0000ff">struct</span></b><span style="color: #000000"> </span><span style="color: #000000">sk_buff</span><span style="color: #000000"> </span><span style="color: #ff0000">*</span><span style="color: #000000">))</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">17  </td>          <td><span style="color: #000000">{</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">18  </td>          <td><b><span style="color: #0000ff">return</span></b><span style="color: #000000"> </span><span style="color: #000000">NF_DROP;</span><span style="color: #008000">//</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">19  </td>          <td><span style="color: #000000">}</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">20  </td>          <td> </td>       </tr>        <tr>         <td style="color: teal" valign="top">21  </td>          <td><b><span style="color: #0000ff">int</span></b><span style="color: #000000"> </span><span style="color: #000000">init_module()</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">22  </td>          <td><span style="color: #000000">{</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">23  </td>          <td><span style="color: #008000">//</span><span style="color: #008000">fill</span><span style="color: #008000"> </span><span style="color: #008000">in</span><span style="color: #008000"> </span><span style="color: #008000">our</span><span style="color: #008000"> </span><span style="color: #008000">ops</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">24  </td>          <td><span style="color: #000000">nfho</span><span style="color: #ff0000">.</span><span style="color: #000000">hook</span><span style="color: #000000"> </span><span style="color: #000000"> </span><span style="color: #000000"> </span><span style="color: #ff0000">=</span><span style="color: #000000"> </span><span style="color: #000000">hook_func</span><span style="color: #000000"> </span><span style="color: #000000">;</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">25  </td>          <td><span style="color: #000000">nfho</span><span style="color: #ff0000">.</span><span style="color: #000000">hoonum</span><span style="color: #000000"> </span><span style="color: #ff0000">=</span><span style="color: #000000"> </span><span style="color: #000000">NF_IP_PRE_ROUTING;</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">26  </td>          <td><span style="color: #000000">nfho</span><span style="color: #ff0000">.</span><span style="color: #000000">pf</span><span style="color: #000000"> </span><span style="color: #000000"> </span><span style="color: #000000"> </span><span style="color: #000000"> </span><span style="color: #000000"> </span><span style="color: #ff0000">=</span><span style="color: #000000"> </span><span style="color: #000000">PF_INET;</span><span style="color: #008000">//</span><span style="color: #008000">family</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">27  </td>          <td><span style="color: #000000">nfho</span><span style="color: #ff0000">.</span><span style="color: #000000">priotity</span><span style="color: #000000"> </span><span style="color: #ff0000">=</span><span style="color: #000000"> </span><span style="color: #000000">NF_IP_PRI_FIRST</span><span style="color: #000000"> </span><span style="color: #000000">;</span><span style="color: #008000">//</span><span style="color: #008000">run</span><span style="color: #008000"> </span><span style="color: #008000">our</span><span style="color: #008000"> </span><span style="color: #008000">func</span><span style="color: #008000"> </span><span style="color: #008000">first</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">28  </td>          <td> </td>       </tr>        <tr>         <td style="color: teal" valign="top">29  </td>          <td><span style="color: #000000">nf_register_hook(</span><span style="color: #ff0000">&</span><span style="color: #000000">nfho);</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">30  </td>          <td><b><span style="color: #0000ff">return</span></b><span style="color: #000000"> </span><b><span style="color: #008080">0</span></b><span style="color: #000000">;</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">31  </td>          <td><span style="color: #000000">}</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">32  </td>          <td> </td>       </tr>        <tr>         <td style="color: teal" valign="top">33  </td>          <td><b><span style="color: #0000ff">void</span></b><span style="color: #000000"> </span><span style="color: #000000">cleanup_module()</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">34  </td>          <td><span style="color: #000000">{</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">35  </td>          <td><span style="color: #000000">nf_unregister_hook(</span><span style="color: #ff0000">&</span><span style="color: #000000">nfho);﻿</span></td>       </tr>        <tr>         <td style="color: teal" valign="top">36  </td>          <td><span style="color: #000000">}</span></td>       </tr>     </tbody></table> </div>
