--- 
title: Evernote Architectural Digest
type: post
layout: post
tags: 
- Evernote
- System
---
<p><img style="display: block; float: none; margin-left: auto; margin-right: auto" height="310" src="http://blog.evernote.com/tech/wp-content/uploads/2011/05/evernote-highlevel-architecture1-282x300.png" width="292" /> </p>  <blockquote>   <p>此文是整理的Evernote blog中《Architectural Digest》一文的要点，使用的是原文图片，图片不清晰，只能大概了解一下Evernote的框架，要想理解具体怎么回事，还是读读原文比较好.</p>    <p>附原文链接：<a title="http://blog.evernote.com/tech/2011/05/17/architectural-digest/" href="http://blog.evernote.com/tech/2011/05/17/architectural-digest/" target="_blank">http://blog.evernote.com/tech/2011/05/17/architectural-digest/</a></p> </blockquote>  <p> </p>  <p>  所有来自Evernote和发往Evernote的数据都是通过https 443端口与<a href="http://www.evernote.com">www.evernote.com</a>交互的，这包括所有基于第三方服务API的同步客户端。每天大约有150 million 的https请求，峰值可以达到250Mbps.</p>  <p>Shards</p>  <p>  Evernote服务的核心部分被称为Shards(原意是碎片，本质是a farm of servers.）</p>  <p>  部署Shards服务器时，Shards会被成对地封装成SuperMicro Box，每个SuperMicro box配置了两个四核处理器、大量的Ram、Seagate企业级drivers…… 每个SuperMicro box上运行debian系统来管理两个Xen的虚拟机（这里应该指的是Shards）.</p>  <p>  两个Xen分主次，主VM上运行核心的应用：Debian + <a href="http://www.oracle.com/technetwork/java/javase/overview/index-jsp-136246.html">Java 6</a> + <a href="http://tomcat.apache.org/">Tomcat</a> + <a href="http://www.hibernate.org/">Hibernate</a> + <a href="http://ehcache.org/">Ehcache</a> +  <a href="http://www.stripesframework.org/display/stripes/Home">Stripes</a> + <a href="http://code.google.com/webtoolkit/">GWT</a> + <a href="http://www.mysql.com/">MySQL</a> (for metadata) + hierarchical local file systems (for file data)</p>  <p>  主VM上的数据会被同步地复制到其他位于不同box的VM上. 每种用户的数据在Evernote的服务器中至少存在于四个不同的企业级drive中.</p>  <p>  通过使用Heartbeat, 当访问主VM中的数据失败时,访问位于另一个box中的备份数据,由此产生的downtime可以达到最小.</p>  <p>UserStore</p>  <p>  虽然绝大部分的用户数据存储在单程NoteStore shards中, 通过使用少量的用户帐户信息,比如用户名、MD5加密后的密码、共享ID等，他们可以共用一个单独的master userStore account Mysql数据库。</p>  <p>Air Processors: </p>  <p>  为了支持用户搜索note中的图片内的关键字，我们使用28台配置8核处理器的server来处理每天的新上传图片。目前这些机器混合使用Linux和Windows，我们打算在月底机器全部转换成Debian Linux.</p>  <p>  这些机器上运行着我们软件研发团队开发的Advanced  Imaging and Recognition软件（AIR），AIR处理每一幅图片，识别文字区，通过配合使用一组识别引擎（recognition engines），每个引擎计算出一个可能结果的集合，AIR尝试compile出一个可能匹配的words加权列表。</p>  <p>Other Services</p>  <p>  所有这些服务部署在位于california的数据中心。这些硬件除了提供核心的服务，还有一小部分server来提供轻量级的服务，这些轻量级的服务可能只需要一到两个box或Xen VM就可以解决，例如我们的mail服务等.</p>  <p>补充：</p>  <p>1. Evernote使用的是自己的服务器，而不是租用的云服务商 </p>  <p>2. Evernote使用的是Java+SQL，本地存储模式</p>
